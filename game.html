<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Samfunnssimulatoren 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f172a;
            color: white;
            user-select: none;
            overflow: hidden; /* Critical: Prevent full page scroll */
            height: 100vh;    /* Force full height */
            width: 100vw;
        }

        /* --- Simulator Specifics --- */
        .sim-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 8px;
            padding: 10px;
            overflow-y: auto;
            height: 100%;
            align-content: start;
        }
        
        .sim-item {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem;
            height: 45px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        /* Floating Text */
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.1); }
        }
        .floating-text {
            position: absolute; pointer-events: none;
            font-weight: 900; font-size: 1.2rem;
            animation: floatUpFade 0.8s ease-out forwards;
            z-index: 100; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* Button Press Effect */
        .btn-press:active { transform: scale(0.95); }
        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: white; cursor: pointer; margin-top: -7px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px;
        }

        /* Glassmorphism for Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal Animation */
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-anim { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-[url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')] bg-cover bg-center">
    
    <!-- Dark Overlay for background readability -->
    <div class="absolute inset-0 bg-slate-900/90 z-0"></div>

    <!-- MAIN UI WRAPPER: Flex column ensures it fills height but never overflows -->
    <div class="relative z-10 flex flex-col h-full w-full max-w-7xl mx-auto p-2 md:p-4 gap-2 md:gap-4">

        <!-- TOP BAR: STATS (Fixed Height-ish, Flex-none) -->
        <header class="flex-none glass-panel rounded-2xl p-3 md:p-4 flex flex-col md:flex-row justify-between items-center gap-2 md:gap-4 shadow-xl">
            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="bg-slate-700 hover:bg-slate-600 rounded-full w-8 h-8 flex items-center justify-center text-sm transition-colors">‚Üê</a>
                    <div>
                        <h1 class="font-black text-lg md:text-xl text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 to-purple-300">SAMFUNNSSIMULATOR</h1>
                        <div id="sim-phase-text" class="text-[10px] font-bold uppercase tracking-widest text-emerald-400">Fase 1: Jordbrukssamfunn</div>
                    </div>
                </div>
                 <!-- Mobile Pause Button visible only on small screens -->
                 <button onclick="togglePause()" class="md:hidden bg-slate-700 text-white text-xs px-3 py-2 rounded-lg btn-press">‚è∏Ô∏è</button>
            </div>

            <!-- Stats Grid -->
            <div class="flex gap-3 md:gap-6 text-center w-full md:w-auto justify-around md:justify-center bg-black/20 md:bg-transparent p-2 md:p-0 rounded-lg">
                <div class="relative group">
                    <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-wider">Befolkning</div>
                    <div class="text-lg md:text-xl font-bold" id="sim-pop">10</div>
                    <div class="text-[9px] text-gray-400 absolute -bottom-3 w-full hidden md:block" id="sim-unemployed">0 ledige</div>
                </div>
                <div>
                    <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-wider">Mat</div>
                    <div class="text-lg md:text-xl font-bold text-emerald-400" id="sim-food">50</div>
                    <div class="text-[9px] hidden md:block" id="sim-food-change">(+0)</div>
                </div>
                <div>
                    <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-wider">Penger</div>
                    <div class="text-lg md:text-xl font-bold text-yellow-400" id="sim-money">50 kr</div>
                    <div class="text-[9px] hidden md:block" id="sim-money-change">(+0)</div>
                </div>
                <div class="hidden sm:block">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wider">Inflasjon</div>
                    <div class="text-xl font-bold text-red-400" id="sim-inflation">0%</div>
                </div>
                 <div>
                    <div class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-wider">Score</div>
                    <div class="text-lg md:text-xl font-bold text-indigo-400" id="sim-score">0</div>
                </div>
            </div>

            <!-- Global Actions (Desktop) -->
             <div class="hidden md:flex gap-2">
                 <button onclick="printMoney(event)" class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-200 text-xs px-3 py-2 rounded-lg btn-press transition-colors" title="Trykk penger (√òker inflasjon)">
                    üñ®Ô∏è +50 kr
                 </button>
                 <button onclick="togglePause()" id="btn-pause" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-3 py-2 rounded-lg btn-press">
                    ‚è∏Ô∏è
                 </button>
             </div>
        </header>

        <!-- MIDDLE: THE VISUAL CITY (Flex-1 + min-h-0 is crucial for scroll within flex) -->
        <section class="flex-1 min-h-0 glass-panel rounded-2xl relative overflow-hidden shadow-2xl flex flex-col">
            <div class="absolute top-0 left-0 bg-black/20 text-xs px-3 py-1 rounded-br-lg text-gray-400 border-b border-r border-white/5 z-10">Din Sivilisasjon</div>
            
            <!-- This container handles the internal scroll -->
            <div id="sim-city-view" class="sim-grid pt-10 pb-4"></div>
            
            <!-- START OVERLAY -->
            <div id="start-overlay" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-50 p-4">
                <div class="text-6xl mb-4 animate-bounce">üåç</div>
                <h2 class="text-3xl font-bold mb-2 text-white text-center">Velkommen H√∏vding</h2>
                <p class="text-sm text-gray-400 mb-6 text-center max-w-md leading-relaxed">
                    Du starter i fattigdom. M√•let er rikdom.<br>
                    Balanser <strong>mat</strong> (b√∏nder) og <strong>penger</strong> (arbeidere).<br>
                    Pass deg for <strong>inflasjon</strong>.
                </p>
                <div class="flex flex-col sm:flex-row gap-2 bg-slate-800 p-2 rounded-xl border border-slate-700">
                        <input type="password" id="pass-input" placeholder="Passord..." class="bg-slate-700 border-none px-4 py-2 rounded-lg text-sm text-center focus:ring-2 focus:ring-indigo-500 outline-none text-white w-full sm:w-32">
                        <button onclick="attemptStart()" class="bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm btn-press shadow-lg whitespace-nowrap">Start Spillet</button>
                </div>
                <p id="pass-msg" class="text-red-500 text-xs mt-3 font-bold opacity-0 transition-opacity">Feil passord</p>
            </div>
        </section>

        <!-- BOTTOM: COMMAND CENTER (Controls) (Flex-none ensures it stays visible) -->
        <footer class="flex-none grid grid-cols-1 md:grid-cols-12 gap-2 md:gap-4 h-auto md:h-32">
            
            <!-- 1. Allocation (Sliders) - Span 6 -->
            <div class="glass-panel rounded-2xl p-3 md:p-4 md:col-span-6 flex flex-col justify-center">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Arbeidsfordeling</div>
                    <div class="text-[10px] text-gray-500 bg-black/20 px-2 py-0.5 rounded">Ledige: <span id="cc-unemployed" class="text-white">0</span></div>
                </div>
                
                <!-- Farmers Slider -->
                <div class="mb-2 md:mb-3">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-emerald-300 font-bold flex items-center gap-1">üåæ B√∏nder</span>
                        <span class="text-gray-400"><span id="cc-farmers">0</span> / <span id="cc-max-farmers">4</span></span>
                    </div>
                    <input type="range" id="slider-farmers" class="w-full accent-emerald-500 touch-pan-x" min="0" max="10" value="0" oninput="updateAllocation()">
                </div>

                <!-- Workers Slider -->
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-blue-300 font-bold flex items-center gap-1">üè≠ Arbeidere</span>
                        <span class="text-gray-400"><span id="cc-workers">0</span> / <span id="cc-max-workers">0</span></span>
                    </div>
                    <input type="range" id="slider-workers" class="w-full accent-blue-500 touch-pan-x" min="0" max="10" value="0" oninput="updateAllocation()">
                </div>
            </div>

            <!-- 2. Buildings (Big Buttons) - Span 4 -->
            <div class="md:col-span-4 grid grid-cols-2 gap-2 md:gap-3 h-24 md:h-full">
                <button onclick="build('farm', event)" id="btn-farm" class="btn-press glass-panel rounded-xl hover:bg-emerald-900/30 border-emerald-500/30 flex flex-col items-center justify-center gap-1 transition-all group">
                    <div class="text-xl md:text-2xl group-hover:scale-110 transition-transform">üåæ</div>
                    <div class="font-bold text-emerald-200 text-xs md:text-sm">Bygg G√•rd</div>
                    <div class="text-[10px] md:text-xs text-yellow-400 bg-black/30 px-2 rounded">15 kr</div>
                </button>

                <button onclick="build('factory', event)" id="btn-factory" class="btn-press glass-panel rounded-xl hover:bg-blue-900/30 border-blue-500/30 flex flex-col items-center justify-center gap-1 transition-all group btn-disabled opacity-50 relative overflow-hidden">
                    <div class="text-xl md:text-2xl group-hover:scale-110 transition-transform">üè≠</div>
                    <div class="font-bold text-blue-200 text-xs md:text-sm">Bygg Fabrikk</div>
                    <div class="text-[10px] md:text-xs text-yellow-400 bg-black/30 px-2 rounded">50 kr</div>
                    <div id="lock-icon" class="absolute inset-0 bg-slate-900/80 flex items-center justify-center">üîí</div>
                </button>
            </div>

            <!-- 3. Tech Button - Span 2 -->
            <div class="md:col-span-2 h-24 md:h-full">
                <button onclick="toggleTechModal()" class="btn-press w-full h-full glass-panel rounded-xl bg-gradient-to-br from-purple-900/40 to-indigo-900/40 hover:from-purple-800/50 hover:to-indigo-800/50 border-purple-500/30 flex flex-col items-center justify-center gap-2 transition-all group">
                    <div class="text-2xl md:text-3xl group-hover:rotate-12 transition-transform">üß™</div>
                    <div class="font-bold text-purple-200 text-xs md:text-sm uppercase tracking-wide">Forskning</div>
                </button>
            </div>
            
            <!-- Mobile Money Print (Extra button row for small screens) -->
            <div class="md:hidden col-span-1">
                 <button onclick="printMoney(event)" class="w-full bg-red-500/20 border border-red-500/50 text-red-200 text-xs py-2 rounded-lg btn-press">
                    üñ®Ô∏è Trykk Penger (+50kr)
                 </button>
            </div>
        </footer>
    </div>

    <!-- TECH TREE MODAL (POPUP) -->
    <dialog id="tech-modal" class="bg-transparent p-0 w-full max-w-2xl backdrop:bg-black/80 backdrop:backdrop-blur-sm m-auto">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl shadow-2xl overflow-hidden modal-enter text-white mx-4">
            <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-400 flex items-center gap-2">
                    <span>üß™</span> Forskningslab
                </h2>
                <button onclick="toggleTechModal()" class="text-gray-400 hover:text-white text-xl font-bold px-2">&times;</button>
            </div>
            
            <div class="p-4 md:p-6 grid gap-4 max-h-[60vh] overflow-y-auto">
                
                <!-- Tech Card 1 -->
                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex justify-between items-center hover:border-emerald-500 transition-colors group">
                    <div>
                        <h3 class="font-bold text-emerald-300 text-base md:text-lg">Kunstgj√∏dsel</h3>
                        <p class="text-xs text-gray-400 mb-2">Gj√∏r at b√∏nder produserer <span class="text-white font-bold">50% mer mat</span>.</p>
                        <div class="text-[10px] bg-slate-800 inline-block px-2 py-1 rounded text-gray-400">Frigj√∏r arbeidskraft</div>
                    </div>
                    <button onclick="buyTech('fertilizer', event)" id="tech-btn-fertilizer" class="bg-slate-800 hover:bg-emerald-600 border border-slate-600 text-white px-3 py-2 rounded-lg font-bold text-xs md:text-sm min-w-[70px] transition-colors">
                        100 kr
                    </button>
                </div>

                <!-- Tech Card 2 -->
                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex justify-between items-center hover:border-blue-500 transition-colors group opacity-50" id="card-steam">
                    <div>
                        <h3 class="font-bold text-blue-300 text-base md:text-lg">Dampmaskin</h3>
                        <p class="text-xs text-gray-400 mb-2">Gj√∏r at fabrikker tjener <span class="text-white font-bold">50% mer penger</span>.</p>
                        <div class="text-[10px] bg-slate-800 inline-block px-2 py-1 rounded text-gray-400">Krever Kunstgj√∏dsel</div>
                    </div>
                    <button onclick="buyTech('steam', event)" id="tech-btn-steam" class="bg-slate-800 hover:bg-blue-600 border border-slate-600 text-white px-3 py-2 rounded-lg font-bold text-xs md:text-sm min-w-[70px] transition-colors cursor-not-allowed">
                        250 kr
                    </button>
                </div>

                <!-- Tech Card 3 -->
                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600 flex justify-between items-center hover:border-pink-500 transition-colors group opacity-50" id="card-medicine">
                    <div>
                        <h3 class="font-bold text-pink-300 text-base md:text-lg">Vaksiner</h3>
                        <p class="text-xs text-gray-400 mb-2">Gir umiddelbar <span class="text-white font-bold">befolkningsvekst (+5)</span>.</p>
                        <div class="text-[10px] bg-slate-800 inline-block px-2 py-1 rounded text-gray-400">Reduserer d√∏delighet</div>
                    </div>
                    <button onclick="buyTech('medicine', event)" id="tech-btn-medicine" class="bg-slate-800 hover:bg-pink-600 border border-slate-600 text-white px-3 py-2 rounded-lg font-bold text-xs md:text-sm min-w-[70px] transition-colors cursor-not-allowed">
                        500 kr
                    </button>
                </div>

            </div>
        </div>
    </dialog>

    <!-- GAME OVER MODAL -->
    <div id="modal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-800 p-8 rounded-2xl max-w-md w-full text-center border border-slate-600 shadow-2xl">
            <div class="text-6xl mb-4 animate-bounce" id="modal-icon">üíÄ</div>
            <h2 class="text-2xl md:text-3xl font-black text-white mb-2" id="modal-title">GAME OVER</h2>
            <p class="text-gray-300 mb-6" id="modal-desc">...</p>
            <button onclick="location.reload()" class="bg-white text-slate-900 font-bold px-8 py-3 rounded-full hover:bg-gray-200 transition-transform hover:scale-105 w-full">Spill p√• nytt</button>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        const state = {
            running: false,
            tickTimer: null,
            pop: 10,
            food: 50,
            money: 50,
            printedMoney: 0,
            price: 10,
            inflation: 0,
            score: 0,
            farms: 4,
            factories: 0,
            farmers: 4,
            workers: 0,
            farmTech: 1.0,
            factoryTech: 1.0,
            phase: 1,
            techs: []
        };

        // --- CORE LOOP ---
        function tick() {
            if(!state.running) return;

            // 1. Allocation Limit
            const totalJobs = state.farmers + state.workers;
            if(totalJobs > state.pop) {
                if(state.workers > 0) state.workers--;
                else if(state.farmers > 0) state.farmers--;
                updateSliders();
            }

            // 2. Production
            const foodProd = state.farmers * 6 * state.farmTech;
            const moneyProd = state.workers * 8 * state.factoryTech;
            state.food += foodProd;
            state.money += moneyProd;

            // 3. Consumption
            const consumption = Math.ceil(state.pop * 1.5);
            state.food -= consumption;

            // 4. Malthus/Growth
            if(state.food < 0) {
                state.food = 0;
                if(Math.random() > 0.5) {
                    state.pop--;
                    spawnFloatText(window.innerWidth/2, window.innerHeight/2, "‚ò†Ô∏è D√∏d", "text-red-500");
                }
                if(state.pop <= 0) gameOver("Sulted√∏den", "Samfunnet kollapset.", "üíÄ");
            } else if(state.food > state.pop * 10) {
                if(Math.random() > 0.7) {
                    state.pop++;
                    spawnFloatText(window.innerWidth/2, window.innerHeight/2, "üë∂ F√∏dsel", "text-emerald-300");
                }
            }

            // 5. Economy
            const productivity = Math.max(1, (foodProd/2) + (moneyProd/2));
            const inflationPush = (state.printedMoney / productivity) * 0.8;
            const deflationPull = productivity * 0.02;
            let targetPrice = 10 + inflationPush - deflationPull;
            targetPrice = Math.max(5, targetPrice);
            
            if(state.price < targetPrice) state.price += 0.5;
            if(state.price > targetPrice) state.price -= 0.5;
            state.inflation = Math.floor(((state.price - 10) / 10) * 100);

            if(state.inflation > 300) gameOver("Hyperinflasjon", "Pengene ble verdil√∏se.", "üí∏");

            // 6. Score & Phase
            state.score = Math.floor((state.pop * 10) + (state.money / 10) + (state.techs.length * 500));
            if(state.inflation > 0) state.score = Math.floor(state.score / (1 + (state.inflation/100)));

            updatePhase();
            updateUI();
        }

        function updatePhase() {
            const factoryBtn = document.getElementById('btn-factory');
            const lockIcon = document.getElementById('lock-icon');
            
            if(state.score > 200 && state.phase < 2) {
                state.phase = 2;
                spawnFloatText(window.innerWidth/2, window.innerHeight/2, "FASE 2: INDUSTRI!", "text-blue-400 text-2xl");
                factoryBtn.classList.remove('btn-disabled', 'opacity-50');
                lockIcon.classList.add('hidden');
                document.getElementById('sim-phase-text').innerText = "Fase 2: Industri";
                document.getElementById('sim-phase-text').className = "text-[10px] font-bold uppercase tracking-widest text-blue-400";
            }
            if(state.score > 1000 && state.phase < 3) {
                state.phase = 3;
                document.getElementById('sim-phase-text').innerText = "Fase 3: Moderne";
                document.getElementById('sim-phase-text').className = "text-[10px] font-bold uppercase tracking-widest text-purple-400";
            }
        }

        // --- ACTIONS ---
        window.updateAllocation = function() {
            const farmersReq = parseInt(document.getElementById('slider-farmers').value);
            const workersReq = parseInt(document.getElementById('slider-workers').value);
            
            let newFarmers = Math.min(farmersReq, state.farms);
            let newWorkers = Math.min(workersReq, state.factories);
            const total = newFarmers + newWorkers;
            
            if(total > state.pop) {
                const diff = total - state.pop;
                if(newWorkers > 0) newWorkers = Math.max(0, newWorkers - diff);
                else newFarmers = Math.max(0, newFarmers - diff);
            }

            state.farmers = newFarmers;
            state.workers = newWorkers;
            updateUI();
        }

        window.build = function(type, e) {
            let cost = 0;
            let success = false;
            let msg = "";

            if(type === 'farm') {
                cost = 15;
                if(state.money >= cost) {
                    state.money -= cost;
                    state.farms++;
                    success = true;
                    msg = "+1 G√•rd";
                }
            }
            if(type === 'factory') {
                cost = 50;
                if(state.phase < 2) return; // Locked
                if(state.money >= cost) {
                    state.money -= cost;
                    state.factories++;
                    success = true;
                    msg = "+1 Fabrikk";
                }
            }

            if(success) {
                spawnFloatText(e.clientX, e.clientY, `-${cost} kr`, "text-red-500");
                setTimeout(() => spawnFloatText(e.clientX, e.clientY - 40, msg, "text-emerald-400"), 200);
                updateAllocation(); 
                updateUI();
            }
        }

        window.toggleTechModal = function() {
            const modal = document.getElementById('tech-modal');
            if(modal.open) modal.close();
            else modal.showModal();
        }

        window.buyTech = function(id, e) {
            if(state.techs.includes(id)) return;
            let cost = 0;
            let success = false;
            
            if(id === 'fertilizer') {
                cost = 100;
                if(state.money >= cost) {
                    state.money -= cost;
                    state.farmTech = 1.5;
                    state.techs.push(id);
                    document.getElementById('tech-btn-fertilizer').innerText = "Kj√∏pt";
                    document.getElementById('tech-btn-fertilizer').className = "bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm";
                    
                    // Unlock Steam visual
                    document.getElementById('card-steam').classList.remove('opacity-50');
                    document.getElementById('tech-btn-steam').classList.remove('cursor-not-allowed');
                    success = true;
                }
            }
            else if(id === 'steam') {
                cost = 250;
                // Pre-req check
                if(!state.techs.includes('fertilizer')) return;

                if(state.money >= cost) {
                    state.money -= cost;
                    state.factoryTech = 1.5;
                    state.techs.push(id);
                    document.getElementById('tech-btn-steam').innerText = "Kj√∏pt";
                    document.getElementById('tech-btn-steam').className = "bg-blue-600 text-white px-4 py-2 rounded-lg text-sm";
                    
                    // Unlock Medicine visual
                    document.getElementById('card-medicine').classList.remove('opacity-50');
                    document.getElementById('tech-btn-medicine').classList.remove('cursor-not-allowed');
                    success = true;
                }
            }
            else if(id === 'medicine') {
                cost = 500;
                if(!state.techs.includes('steam')) return;

                 if(state.money >= cost) {
                    state.money -= cost;
                    state.techs.push(id);
                    state.pop += 5; 
                    document.getElementById('tech-btn-medicine').innerText = "Kj√∏pt";
                    document.getElementById('tech-btn-medicine').className = "bg-pink-600 text-white px-4 py-2 rounded-lg text-sm";
                    success = true;
                 }
            }

            if(success) {
                // Assuming button click inside modal, coordinates might be tricky relative to viewport, so just center float
                const rect = e.target.getBoundingClientRect();
                spawnFloatText(rect.left + 20, rect.top, `-${cost} kr`, "text-red-500");
                updateUI();
            }
        }

        window.printMoney = function(e) {
            state.money += 50;
            state.printedMoney += 50;
            spawnFloatText(e.clientX, e.clientY, "+50 kr", "text-green-400");
            setTimeout(() => spawnFloatText(e.clientX, e.clientY-30, "INFLASJON!", "text-red-500 text-sm"), 300);
            updateUI();
        }

        // --- UI UPDATES ---
        function updateUI() {
            // Stats
            document.getElementById('sim-money').innerText = Math.floor(state.money) + " kr";
            document.getElementById('sim-pop').innerText = state.pop;
            document.getElementById('sim-food').innerText = Math.floor(state.food);
            document.getElementById('sim-inflation').innerText = state.inflation + "%";
            document.getElementById('sim-score').innerText = state.score;

            // Job Allocations (Sliders & Text)
            document.getElementById('cc-farmers').innerText = state.farmers;
            document.getElementById('cc-max-farmers').innerText = state.farms;
            document.getElementById('cc-workers').innerText = state.workers;
            document.getElementById('cc-max-workers').innerText = state.factories;
            
            const unemployed = state.pop - (state.farmers + state.workers);
            document.getElementById('sim-unemployed').innerText = unemployed + " ledige";
            document.getElementById('cc-unemployed').innerText = unemployed;
            document.getElementById('cc-unemployed').className = unemployed > 0 ? "text-yellow-400 font-bold" : "text-gray-500";

            // Sliders
            const sFarm = document.getElementById('slider-farmers');
            sFarm.max = Math.min(state.pop, state.farms);
            sFarm.value = state.farmers;
            
            const sWork = document.getElementById('slider-workers');
            sWork.max = Math.min(state.pop, state.factories);
            sWork.value = state.workers;

            // Changes/Rates
            const fChange = (state.farmers * 6 * state.farmTech) - Math.ceil(state.pop * 1.5);
            const fEl = document.getElementById('sim-food-change');
            fEl.innerText = (fChange >= 0 ? "+" : "") + Math.floor(fChange) + "/t";
            fEl.className = fChange < 0 ? "text-[9px] text-red-500 font-bold shake-anim" : "text-[9px] text-gray-500";
            
            const mChange = (state.workers * 8 * state.factoryTech);
            document.getElementById('sim-money-change').innerText = "+" + Math.floor(mChange) + "/t";

            // Visual City
            const city = document.getElementById('sim-city-view');
            const targetCount = state.farms + state.factories + Math.ceil(state.pop/2);
            if(city.childElementCount !== targetCount) {
                city.innerHTML = '';
                for(let i=0; i<state.farms; i++) city.appendChild(createIcon('üåæ'));
                for(let i=0; i<state.factories; i++) city.appendChild(createIcon('üè≠'));
                for(let i=0; i<Math.ceil(state.pop/2); i++) city.appendChild(createIcon(state.phase < 2 ? '‚õ∫' : 'üè†'));
            }
        }

        function createIcon(emoji) {
            const d = document.createElement('div');
            d.className = 'sim-item';
            d.innerText = emoji;
            return d;
        }

        function updateSliders() {
            document.getElementById('slider-farmers').value = state.farmers;
            document.getElementById('slider-workers').value = state.workers;
        }

        // --- SYSTEM ---
        window.attemptStart = function() {
            const pass = document.getElementById('pass-input').value.toLowerCase().trim();
            if(pass === '√∏konomi') {
                document.getElementById('start-overlay').classList.add('hidden');
                state.running = true;
                state.tickTimer = setInterval(tick, 1000); 
            } else {
                const msg = document.getElementById('pass-msg');
                msg.classList.remove('opacity-0');
                setTimeout(() => msg.classList.add('opacity-0'), 2000);
            }
        }

        window.togglePause = function() {
            state.running = !state.running;
            document.getElementById('btn-pause').innerText = state.running ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
        }
        
        function gameOver(title, desc, icon) {
            state.running = false;
            clearInterval(state.tickTimer);
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerText = desc;
            document.getElementById('modal-icon').innerText = icon;
        }

        window.spawnFloatText = function(x, y, text, colorClass) {
            const el = document.createElement('div');
            el.className = `floating-text ${colorClass}`;
            el.innerText = text;
            el.style.left = (x - 20) + 'px'; 
            el.style.top = (y - 20) + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // Init
        updateUI();
    </script>
</body>
</html>
